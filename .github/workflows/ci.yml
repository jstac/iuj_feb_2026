name: Build Project [using jupyter-book]
on: 
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    runs-on: "runs-on=${{ github.run_id }}/family=g4dn.2xlarge/image=quantecon_ubuntu2404/disk=large"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Anaconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate-base: true
          miniconda-version: 'latest'
          python-version: "3.13"
          environment-file: environment.yml
          activate-environment: quantecon

      - name: Check nvidia Drivers
        shell: bash -l {0}
        run: nvidia-smi

      - name: Install JAX and Numpyro
        shell: bash -l {0}
        run: |
          pip install -U "jax[cuda13]"
          pip install numpyro
          python scripts/test-jax-install.py

      - name: Display Conda Environment Versions
        shell: bash -l {0}
        run: conda list

      - name: Display Pip Versions
        shell: bash -l {0}
        run: pip list

      # Build HTML
      - name: Build HTML
        shell: bash -l {0}
        run: |
          jb build lectures --path-output ./ -n -W --keep-going

      - name: Build Download Notebooks (sphinx-tojupyter)
        shell: bash -l {0}
        run: |
          jb build lectures --path-output ./ --builder=custom --custom-builder=jupyter -n -W --keep-going

      - name: Copy notebooks for download support
        shell: bash -l {0}
        run: |
          mkdir -p _build/html/_notebooks
          cp _build/jupyter/*.ipynb _build/html/_notebooks/ 2>/dev/null || true
          echo "Notebooks copied to _build/html/_notebooks/ for download:"
          ls -la _build/html/_notebooks/

      - name: Upload Execution Reports (HTML)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: execution-reports-html
          path: _build/html/reports

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Preview Deploy to Netlify
        uses: QuantEcon/actions/preview-netlify@main
        with:
          netlify-auth-token: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          netlify-site-id: ${{ secrets.NETLIFY_SITE_ID }}
          build-dir: _build/html
          lectures-dir: lectures
