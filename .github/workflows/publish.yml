name: Build & Publish to GH Pages
on:
  push:
    branches:
      - main
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: "runs-on=${{ github.run_id }}/family=g4dn.2xlarge/image=quantecon_ubuntu2404/disk=large"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Anaconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate-base: true
          miniconda-version: 'latest'
          python-version: "3.13"
          environment-file: environment.yml
          activate-environment: quantecon
      
      - name: Check nvidia Drivers
        shell: bash -l {0}
        run: nvidia-smi

      - name: Install JAX with CUDA support
        shell: bash -l {0}
        run: |
          pip install -U "jax[cuda13]"
          pip install numpyro
          python scripts/test-jax-install.py

      - name: Display Conda Environment Versions
        shell: bash -l {0}
        run: conda list
      
      - name: Display Pip Versions
        shell: bash -l {0}
        run: pip list
      
      - name: Build HTML
        shell: bash -l {0}
        run: |
          jb build lectures --path-output ./ -n -W --keep-going
      
      - name: Build Download Notebooks (sphinx-tojupyter)
        shell: bash -l {0}
        run: |
          jb build lectures --path-output ./ --builder=custom --custom-builder=jupyter -n -W --keep-going
      
      - name: Copy notebooks for download and Colab support
        shell: bash -l {0}
        run: |
          # Copy to _build/html/_notebooks for download button
          mkdir -p _build/html/_notebooks
          cp _build/jupyter/*.ipynb _build/html/_notebooks/ 2>/dev/null || true
          echo "Notebooks copied to _build/html/_notebooks/ for download:"
          ls -la _build/html/_notebooks/
          # Copy to notebooks/ folder in repo for Colab
          mkdir -p notebooks
          cp _build/jupyter/*.ipynb notebooks/ 2>/dev/null || true
          echo "Notebooks copied to notebooks/ folder for Colab:"
          ls -la notebooks/
      
      - name: Commit notebooks to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add notebooks/
          git diff --staged --quiet || git commit -m "Update notebooks for Colab [skip ci]"
          git push
      
      - name: Upload Execution Reports
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: execution-reports
          path: _build/html/reports
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: _build/html/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
